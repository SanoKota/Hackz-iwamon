<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dream Race | Hackz-iwamon</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
</head>

<body>
    <!-- Background Elements -->
    <div class="bg-circle circle-1"></div>
    <div class="bg-circle circle-2"></div>

    <!-- Hamburger Menu -->
    <div class="menu-container">
        <input type="checkbox" id="menu-toggle">
        <label for="menu-toggle" class="menu-button">
            <span></span>
            <span></span>
            <span></span>
        </label>
        <div class="menu-drawer">
            <nav>
                <a href="/">Horse Generator</a>
                <a href="/race">Dream Race</a>
                <a href="/gallery">Horse Gallery</a>
            </nav>
        </div>
    </div>

    <div class="container">
        <!-- Title / Header -->
        <h1>All-Star Dream Trophy</h1>
        <p class="subtitle" style="text-align: center; color: #cbd5e1; margin-bottom: 2rem;">
            Legends collide. Who is the strongest?
        </p>

        <!-- Control Area -->
        <div class="glass-card" style="margin-bottom: 2rem;">

            <!-- Race Selection Grid -->
            <div id="race-selection-area"
                style="margin-bottom: 2rem; border-bottom: 1px solid #475569; padding-bottom: 1rem;">
                <div class="selection-header" style="margin-bottom: 0.5rem;">
                    <h3 style="margin: 0; color: #fff;">Race Condition</h3>
                </div>
                <select id="race-selector"
                    style="width: 100%; padding: 0.8rem; border-radius: 8px; border: 1px solid #475569; background: #1e293b; color: white; font-size: 1rem;">
                    <option value="" disabled selected>Select a Race...</option>
                </select>
            </div>

            <!-- Horse Selection Grid -->
            <div id="horse-selection-area">
                <div class="selection-header"
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="margin: 0; color: #fff;">Entry Horses</h3>
                    <div class="selection-controls">
                        <button type="button" id="select-random-btn" class="small-btn">Random 12</button>
                        <button type="button" id="clear-btn" class="small-btn secondary">Clear</button>
                    </div>
                </div>
                <div class="horse-grid" id="horse-grid">
                    <!-- Checkboxes will be injected here -->
                </div>
            </div>

            <div style="text-align: center; margin-top: 2rem;">
                <p style="margin-bottom: 1.5rem;">
                    Click the button below to simulate a race between selected horses.
                </p>
                <button id="start-race-btn">
                    Start Dream Race
                </button>
                <!-- Loading Spinner -->
                <div id="loader" class="loader">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- Result Display -->
        <div class="response-area">
            <div class="glass-card">
                <div class="response-title">Live Commentary</div>
                <div class="response-content">{{ response }}</div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const horseGrid = document.getElementById('horse-grid');
            const raceSelector = document.getElementById('race-selector');

            // Function to generate checkboxes
            function generateCheckboxes(horses) {
                if (!horseGrid) return;

                horseGrid.innerHTML = ''; // Clear existing

                horses.forEach((horse, index) => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'horse-checkbox-wrapper';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `horse-${horse.id}`;
                    checkbox.value = horse.value; // Name + Pedigree
                    checkbox.className = 'horse-checkbox';

                    const label = document.createElement('label');
                    label.htmlFor = `horse-${horse.id}`;
                    label.textContent = horse.name;
                    label.title = horse.value;

                    wrapper.appendChild(checkbox);
                    wrapper.appendChild(label);
                    horseGrid.appendChild(wrapper);
                });
            }

            // Function to populate race dropdown
            function populateRaceDropdown(races) {
                if (!raceSelector) return;

                races.forEach(race => {
                    const option = document.createElement('option');
                    option.value = race.race_id;
                    option.textContent = `${race.race_name} (${race.course} ${race.track_type}${race.distance}m)`;
                    raceSelector.appendChild(option);
                });

                // Select first by default if available
                if (races.length > 0) {
                    raceSelector.value = races[0].race_id;
                }
            }

            // Fetch Data from API via CSV
            async function loadData() {
                try {
                    // Load Horses
                    const horsesRes = await fetch('/api/horses');
                    const horsesData = await horsesRes.json();
                    if (horsesData.status === 'success') {
                        generateCheckboxes(horsesData.horses);
                    } else {
                        console.error('Failed to load horses:', horsesData.message);
                    }

                    // Load Races
                    const racesRes = await fetch('/api/races');
                    const racesData = await racesRes.json();
                    if (racesData.status === 'success') {
                        populateRaceDropdown(racesData.races);
                    } else {
                        console.error('Failed to load races:', racesData.message);
                    }

                } catch (error) {
                    console.error('Error fetching data:', error);
                }
            }

            // Initial Load
            loadData();

            // Random Select
            const randomBtn = document.getElementById('select-random-btn');
            if (randomBtn) {
                randomBtn.addEventListener('click', () => {
                    const checkboxes = Array.from(document.querySelectorAll('.horse-checkbox'));
                    // Clear all
                    checkboxes.forEach(cb => cb.checked = false);

                    if (checkboxes.length > 0) {
                        // Select up to 12 random
                        const shuffled = checkboxes.sort(() => 0.5 - Math.random());
                        const count = Math.min(12, shuffled.length);
                        shuffled.slice(0, count).forEach(cb => cb.checked = true);
                    }
                });
            }

            // Clear
            const clearBtn = document.getElementById('clear-btn');
            if (clearBtn) {
                clearBtn.addEventListener('click', () => {
                    document.querySelectorAll('.horse-checkbox').forEach(cb => cb.checked = false);
                });
            }

            const startBtn = document.getElementById('start-race-btn');
            const loader = document.getElementById('loader');
            const responseArea = document.querySelector('.response-area');
            const responseContent = document.querySelector('.response-content');

            if (startBtn) {
                startBtn.addEventListener('click', async () => {
                    // Get Selected Horses
                    const selectedHorses = Array.from(document.querySelectorAll('.horse-checkbox:checked'))
                        .map(cb => cb.value);
                    const selectedRaceId = raceSelector ? raceSelector.value : null;

                    if (selectedHorses.length < 2) {
                        alert('Please select at least 2 horses.');
                        return;
                    }

                    if (!selectedRaceId) {
                        alert('Please select a race.');
                        return;
                    }

                    // UI Updates
                    startBtn.textContent = 'Race in Progress...';
                    startBtn.disabled = true;
                    startBtn.style.opacity = '0.7';
                    loader.style.display = 'flex';
                    responseArea.style.display = 'none';

                    try {
                        const response = await fetch('/api/run_race', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                horses: selectedHorses,
                                race_id: selectedRaceId
                            })
                        });
                        const data = await response.json();

                        if (data.status === 'success') {
                            responseContent.innerHTML = marked.parse(data.result);
                            responseArea.style.display = 'block';
                            responseArea.scrollIntoView({ behavior: 'smooth' });
                        } else {
                            alert('Race simulation failed: ' + data.message);
                        }

                    } catch (error) {
                        console.error('Error:', error);
                        alert('An error occurred during the race simulation.');
                    } finally {
                        // Reset UI
                        loader.style.display = 'none';
                        startBtn.textContent = 'Start Dream Race';
                        startBtn.disabled = false;
                        startBtn.style.opacity = '1';
                    }
                });
            }
        });
    </script>
</body>

</html>